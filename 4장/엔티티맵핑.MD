# 4장 엔티티 매핑
JPA 맵핑은 Annotation 방식과 XML 방식을 지원한다.
최근에 XML 방식은 사용하지 않고 있다.
SpringBoot 의 영향으로 persistence.xml 파일도 필요하지 않다.
Annotation 과 Spring 의 Config 가 알고 있어도 설정에 무리가 없다.


<pre>
	
  // JPA Config File
  @Configuration
  @EnableJpaRepositories(
    basePackages = ["jpa.repository"],
    entityManagerFactoryRef = "entityManagerFactory",
    transactionManagerRef = "transactionManager",
  )
</pre>

<pre>
  
  // EntityManagerFactory
  @Primary
  @Bean
  fun entityManagerFactory(
    builder: EntityManagerFactoryBuilder,
    beanFactory: ConfigurableListableBeanFactory
  ): LocalContainerEntityManagerFactoryBean {
    return builder
      .dataSource(dataSource())
      .packages(EntityClass::class.java.packageName)
      .persistenceUnit("unitname")
      .properties(ImmutableMap.of(AvailableSettings.BEAN_CONTAINER, SpringBeanContainer(beanFactory))
    ).build()
}
 
</pre>


## Annotations
- @Entity
기본 생성자는 필수
IPD 에서는 현재 Kotlin 을 사용하고 있어서 기본 생성자를 사용하는 것이 어렵다.
kotlin-noarg 플러그인을 사용하여 이런 문제를 불편함을 해소하고 있다. 

- @Table
생략 가능하고 없을 경우 엔티티 이름을 테이블로 사용




## 스키마 자동 생성
서비스 규모가 작다면 모르지만 Enterprise 규모의 서비스라면 사실 스키마 자동 생성을 사용할 일은 없을 듯하다.

- create
기존 테이블을 삭제하고 새로 생성 (DROP 후 CREATE)
- create-drop
어플리케이션이 종료되면 DROP
- update
어플리케이션이 기동될 때 맵핑정보에 차이가 있으면 반영
- validate
어플리케이션이 기동될 때 맵핑정보에 차이가 있으면 오류와 함께 종료
- none
자동 생성 기능 미사용

<code>Spring 에서 내장 DB 를 사용하도록 설정했다면 create-drop 그렇지 않다면 none 이 default</code>

JPA 에서는 none, create, drop-and-create, drop 을 지원한다.

권장사항
<pre>
1. 개발초기에는 create / update
2. 자동화된 테스트를 진행하는 개발자 환경 및 CI 서버는 create or create-drop
3. 테스트 서버는 update 또는 validate
4. 스테이징과 운영서버는 validate / none
</pre>
개인적으로는 2번 정도가 현실성 있을 듯 함

## JPA 기본 키 맵핑
- 직접 할당
- Sequence
- Table
- Identity


## Key 전략

식별자 선택 전략은 다음 3가지를 모두 만족해야한다.
1. not null
2. unique
3. immutable

여기에 추가로 <code>자연키 보다는 대리 키를 권장한다.</code>

비지니스 요구사항의 변화에 따라 실존하는 정보를 기반으로 Key 를 잡을 경우 다양한 문제에 국면하게 된다.
예를 들어 주민등록번호를 Key 로 잡은 경우를 보자.
개인정보 보호법에 따라 주민등록번호를 암호화 하거나 저장 자체를 못할 경우 시스템을 갈아 엎어야 하는 문제가 발생할 수 있다.
주민등록번호는 하나의 정보로써 관리하고 대리키를 사용하는 습관을 들이는 것이 전략적으로 유리하다.



